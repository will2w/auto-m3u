name: IPTV Auto Builder Pro

on:
  schedule:
    # æ¯ 12 å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
    - cron: "0 */12 * * *"
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# å…³é”®ï¼šæ·»åŠ å†™å…¥æƒé™ï¼Œé˜²æ­¢ Push å¤±è´¥
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # å¦‚æœä½ é…ç½®äº† PAT_TOKENï¼Œè¯·ä¿ç•™ï¼›å¦åˆ™é»˜è®¤ä½¿ç”¨ github.token
          token: ${{ secrets.PAT_TOKEN || github.token }}

      # 2. å®‰è£…å¿…éœ€å·¥å…· (ä¿®æ­£ï¼šç§»é™¤ awkï¼Œç³»ç»Ÿå·²å†…ç½®)
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl sed

      # 3. ä¸‹è½½æºæ•°æ®
      - name: Download Sources
        run: |
          echo "æ­£åœ¨ä¸‹è½½ M3U æº..."
          curl -L --retry 3 -o china.m3u https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u https://freetv.fun/test_channels_taiwan_new.m3u

      # 4. æ ¸å¿ƒæ„å»ºé€»è¾‘
      - name: Build Playlist
        run: |
          # --- åˆå§‹åŒ– ---
          echo "#EXTM3U x-tvg-url=\"http://epg.51zmt.top:8000/e.xml\"" > playlist.m3u
          > valid_channels.txt
          
          # å®šä¹‰çœä»½æ˜ å°„å­—å…¸
          declare -A PROVINCE_MAP=(
            ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" 
            ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["Inner"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" 
            ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" 
            ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" 
            ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" 
            ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" 
            ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" 
            ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†"
          )

          # --- å‡½æ•°ï¼šæ ‡å‡†åŒ–ä¸è¿‡æ»¤ (åŒ…å«è´­ç‰©é¢‘é“è¿‡æ»¤) ---
          normalize_and_filter() {
              local name="$1"
              # è¿‡æ»¤é»‘åå•ï¼šè´­ç‰©ã€å•†åŸã€æµ‹è¯•ã€ä¸´æ—¶ã€å¹¿å‘Šã€ä»·
              if [[ "$name" =~ "è´­ç‰©" || "$name" =~ "å•†åŸ" || "$name" =~ "æµ‹è¯•" || "$name" =~ "ä»·" || "$name" =~ "ä½“éªŒ" || "$name" =~ "å¹¿æ’­" ]]; then
                  echo "FILTERED"
                  return
              fi
              # æ­£åˆ™å¤„ç†ï¼šç§»é™¤ [HD], (é«˜æ¸…), 4K, ç©ºæ ¼ç­‰
              name=$(echo "$name" | sed -E 's/\[[^]]*\]//g; s/\([^)]*\)//g; s/(é«˜æ¸…|HD|è¶…æ¸…|UHD|4K|FHD|æ ‡æ¸…|SD)//ig; s/ //g; s/^-+//; s/-+$//')
              echo "$name"
          }

          # --- å‡½æ•°ï¼šæµ‹é€Ÿé‡‡é›† ---
          collect_channels () {
            local AREA=$1
            local FILE=$2
            [ ! -f "$FILE" ] && return
            echo "æ­£åœ¨å¤„ç†åŒºåŸŸ: $AREA ..."

            # æå–åç§°å’Œ URL
            grep "#EXTINF" "$FILE" | while read -r LINE; do
                ORIG_NAME=$(echo "$LINE" | sed 's/.*,//')
                URL=$(grep -A 1 "$LINE" "$FILE" | grep "http" | head -n 1)
                
                [ -z "$URL" ] && continue

                # æ‰§è¡Œæ ‡å‡†åŒ–è¿‡æ»¤
                NORM_NAME=$(normalize_and_filter "$ORIG_NAME")
                [ "$NORM_NAME" == "FILTERED" ] && continue

                # æµ‹é€Ÿï¼šè¿æ¥ 2sï¼Œæ€»è€—æ—¶ 4sï¼Œä½¿ç”¨ Head è¯·æ±‚æå‡æ•ˆç‡
                CHECK=$(curl -I -s -w "%{http_code} %{time_connect} %{speed_download}" -o /dev/null --connect-timeout 2 --max-time 4 "$URL" || echo "000 0 0")
                HTTP_CODE=$(echo $CHECK | awk '{print $1}')
                
                if [ "$HTTP_CODE" = "200" ]; then
                    TIME_CONN=$(echo $CHECK | awk '{print $2}')
                    SPEED_DL=$(echo $CHECK | awk '{print $3}')
                    echo -e "${TIME_CONN}\t${SPEED_DL}\t${NORM_NAME}\t${URL}\t${AREA}\t${ORIG_NAME}" >> valid_channels.txt
                fi
            done
          }

          # æ‰§è¡Œå„ä¸ªåŒºåŸŸé‡‡é›†
          collect_channels "China" "china.m3u"
          collect_channels "Hong Kong" "hongkong.m3u"
          collect_channels "Taiwan" "taiwan.m3u"

          # --- æ‹©ä¼˜ï¼šæŒ‰è§„èŒƒååˆ†ç»„ï¼Œé€Ÿåº¦(ç¬¬2åˆ—)å€’åºï¼Œå–æ¯ç»„å‰ 5 å ---
          if [ -s valid_channels.txt ]; then
              sort -t$'\t' -k3,3 -k2,2nr valid_channels.txt | awk -F'\t' '!x[$3]++ || count[$3]++ < 5' > best_channels.txt
          else
              echo "è­¦å‘Šï¼šæœªå‘ç°æœ‰æ•ˆçº¿è·¯ï¼"
              touch best_channels.txt
          fi

          # --- ç»„è£…æœ€ç»ˆ M3U ---
          CURRENT_GROUP=""
          while IFS=$'\t' read -r TIME SPEED NORM URL AREA ORIG; do
              
              # åˆ†ç»„é€»è¾‘
              GROUP_TITLE="å…¶ä»–"
              if [[ "$AREA" == "China" ]]; then
                  if [[ "$ORIG" =~ "CCTV" || "$ORIG" =~ "cctv" ]]; then
                      GROUP_TITLE="ä¸­å›½: å¤®è§†"
                  else
                      GROUP_TITLE="ä¸­å›½: å…¨å›½"
                      for KEY in "${!PROVINCE_MAP[@]}"; do
                          if [[ "$ORIG" == *"$KEY"* || "$ORIG" == *"${PROVINCE_MAP[$KEY]}"* ]]; then
                              GROUP_TITLE="ä¸­å›½: ${PROVINCE_MAP[$KEY]}"
                              break
                          fi
                      done
                  fi
              elif [[ "$AREA" == "Hong Kong" ]]; then GROUP_TITLE="é¦™æ¸¯";
              elif [[ "$AREA" == "Taiwan" ]]; then GROUP_TITLE="å°æ¹¾";
              fi

              # æ’å…¥ç»„æ ‡é¢˜
              if [[ "$GROUP_TITLE" != "$CURRENT_GROUP" ]]; then
                  echo -e "\n# === $GROUP_TITLE ===" >> playlist.m3u
                  CURRENT_GROUP="$GROUP_TITLE"
              fi

              # ç”Ÿæˆå›¾æ ‡å…³é”®å­—ç¬¦
              LOGO_NAME=$(echo "$NORM" | tr -dc '[:alnum:]')
              
              echo "#EXTINF:-1 tvg-logo=\"https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${LOGO_NAME}.png\" group-title=\"$GROUP_TITLE\",$ORIG" >> playlist.m3u
              echo "$URL" >> playlist.m3u

          done < <(sort -t$'\t' -k5,5 -k3,3 best_channels.txt)

      # 5. æäº¤å˜æ›´
      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add playlist.m3u
          if git diff --staged --quiet; then
            echo "æ— å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨: $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main
            git push origin main
          fi

      # 6. æ¸…ç†
      - name: Cleanup
        run: rm -f *.m3u valid_channels.txt best_channels.txt
