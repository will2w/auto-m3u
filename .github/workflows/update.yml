name: IPTV Auto Builder Pro

on:
  schedule:
    # æ¯ 4 å°æ—¶è¿è¡Œä¸€æ¬¡ (æ ‡å‡† Cron è¯­æ³•: åˆ† æ—¶ æ—¥ æœˆ å‘¨)
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3
        with:
          # ç¡®ä¿ PAT_TOKEN å…·æœ‰å†™å…¥æƒé™
          token: ${{ secrets.PAT_TOKEN }}

      # 2. å®‰è£…å¿…éœ€å·¥å…·
      - name: ğŸ› ï¸ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # 3. ä¸‹è½½ M3U æºåˆ—è¡¨
      - name: â¬‡ï¸ Download Source Lists
        run: |
          echo "Downloading M3U sources..."
          curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u

      # 4. ä¸‹è½½ EPG
      - name: â¬‡ï¸ Download EPG
        run: |
          echo "Downloading EPG file..."
          curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

      # 5. ç”Ÿæˆ playlist
      - name: âš™ï¸ Build Playlist (Select Fastest)
        run: |
          # ã€ä¿®æ”¹ç‚¹ã€‘ç›´æ¥åœ¨æ ¹ç›®å½•ç”Ÿæˆ playlist.m3u
          echo "#EXTM3U" > playlist.m3u
          
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶æ¥å­˜æ”¾æ‰€æœ‰æµ‹è¯•é€šè¿‡çš„é¢‘é“æ•°æ®
          touch valid_channels.txt

          # å£°æ˜çœä»½æ˜ å°„
          declare -A PROVINCE_MAP=( 
            ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" 
            ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["InnerMongolia"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" 
            ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" 
            ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" 
            ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" 
            ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" 
            ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" 
            ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†" 
          )

          # å®šä¹‰å¤„ç†å‡½æ•°ï¼šè´Ÿè´£æµ‹é€Ÿå’Œæ”¶é›†æ•°æ®
          collect_channels () {
            AREA=$1
            FILE=$2

            echo "Processing $AREA from $FILE..."

            awk '
              /^#EXTINF/ {
                info=$0;
                getline url;
                if (url ~ /^http/) {
                    print info "\t" url;
                }
              }
            ' "$FILE" | while IFS=$'\t' read -r INFO URL; do
              
              NAME=$(echo "$INFO" | sed 's/.*,//')
              
              # === æ ¸å¿ƒï¼šè·å– HTTPçŠ¶æ€ç  å’Œ å“åº”æ—¶é—´ ===
              # %{time_total} è·å–æ€»è€—æ—¶ (Latency)
              CHECK_RESULT=$(curl -s -w "%{http_code} %{time_total}" -o /dev/null --connect-timeout 3 --max-time 5 "$URL" || echo "000 999")
              
              HTTP_CODE=$(echo "$CHECK_RESULT" | awk '{print $1}')
              LATENCY=$(echo "$CHECK_RESULT" | awk '{print $2}')

              if [[ "$HTTP_CODE" != "200" ]]; then
                # echo "Skipping invalid: $NAME ($URL)"
                continue
              fi

              # å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œæ ¼å¼ï¼šè€—æ—¶ [TAB] åå­— [TAB] URL [TAB] åŒºåŸŸ [TAB] åŸå§‹ä¿¡æ¯
              echo -e "${LATENCY}\t${NAME}\t${URL}\t${AREA}\t${INFO}" >> valid_channels.txt
              # echo "Collected: $NAME ($LATENCY s)"

            done
          }

          # 2. æ”¶é›†æ‰€æœ‰é¢‘é“çš„æµ‹é€Ÿæ•°æ®
          declare -A AREAS=( ["China"]="china.m3u" ["Hong Kong"]="hongkong.m3u" ["Taiwan"]="taiwan.m3u" )
          for AREA in "${!AREAS[@]}"; do
            collect_channels "$AREA" "${AREAS[$AREA]}"
          done

          echo "Sorting and Selecting best sources..."

          # 3. æ’åºä¸å»é‡ï¼šé€‰å‡ºé€Ÿåº¦æœ€å¿«çš„å”¯ä¸€é¢‘é“
          # æ’åºè§„åˆ™ï¼šæŒ‰åå­—åˆ†ç»„(-k2,2)ï¼Œç„¶åæŒ‰è€—æ—¶æ•°å­—å‡åºæ’åº(-k1,1n)
          # å»é‡è§„åˆ™ï¼šawk åªä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„è¡Œ (å³æœ€å¿«çš„é‚£ä¸ª)
          sort -t $'\t' -k2,2 -k1,1n valid_channels.txt | awk -F '\t' '!seen[$2]++' > best_channels.txt

          # 4. å†™å…¥æœ€ç»ˆ M3U æ–‡ä»¶
          write_playlist() {
            TARGET_AREA=$1
            TITLE_TEXT=$2
            
            echo "" >> playlist.m3u
            echo "# ===== $TITLE_TEXT =====" >> playlist.m3u
            
            # ä» best_channels.txt ä¸­è¯»å–å±äºå½“å‰åŒºåŸŸçš„é¢‘é“
            grep "$TARGET_AREA" best_channels.txt | while IFS=$'\t' read -r LATENCY NAME URL AREA INFO; do
              
              CLEAN_NAME=$(echo "$NAME" | tr -dc '[:alnum:][:alpha:]')

              # åŒ¹é… Logo
              LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
              if ! curl --output /dev/null --silent --head --fail "$LOGO_URL"; then
                 LOGO_URL=""
              fi

              # åŒ¹é… EPG
              TVG_ID=$(grep -iF "$NAME" epg.xml | head -1 | sed -n 's/.*tvg-id="\([^"]*\)".*/\1/p')

              # å¤„ç†åˆ†ç»„æ ‡é¢˜
              PROVINCE_CH=""
              if [[ "$AREA" == "China" ]]; then
                PROVINCE_KEY=$(echo "$NAME" | awk '{print $1}')
                PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]}
              fi

              # æ„å»ºæ ‡ç­¾ (åŒ…å« Group-Title)
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              [[ -n "$LOGO_URL" ]] && EXT="${EXT} tvg-logo=\"${LOGO_URL}\""
              
              if [[ -n "$PROVINCE_CH" ]]; then
                EXT="${EXT} group-title=\"ä¸­å›½: ${PROVINCE_CH}\",${NAME}"
              elif [[ "$AREA" == "Hong Kong" ]]; then
                EXT="${EXT} group-title=\"é¦™æ¸¯\",${NAME}"
              elif [[ "$AREA" == "Taiwan" ]]; then
                EXT="${EXT} group-title=\"å°æ¹¾\",${NAME}"
              else
                EXT="${EXT} group-title=\"${AREA}\",${NAME}"
              fi
              
              echo "$EXT" >> playlist.m3u
              echo "$URL" >> playlist.m3u
            done
          }

          # æŒ‰é¡ºåºå†™å…¥ M3U æ–‡ä»¶
          write_playlist "China" "ä¸­å›½é¢‘é“"
          write_playlist "Hong Kong" "é¦™æ¸¯é¢‘é“"
          write_playlist "Taiwan" "å°æ¹¾é¢‘é“"

          echo "Final playlist generated (Root Directory)."
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm valid_channels.txt best_channels.txt

      # 6. Commit & Push (æ¨é€åˆ°æ ¹ç›®å½•)
      - name: â¬†ï¸ Commit and Push Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet playlist.m3u; then
            echo "No changes detected. Skipping commit."
          else
            git add playlist.m3u # ã€ä¿®æ”¹ç‚¹ã€‘åªæ·»åŠ æ ¹ç›®å½•çš„ playlist.m3u
            git commit -m "ğŸš€ Update playlist (Best Speed): $(date +%Y-%m-%d %H:%M:%S)" 
            git push
          fi
