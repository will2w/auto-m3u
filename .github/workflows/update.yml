name: IPTV Auto Builder Pro

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl gawk

      - name: Download Data
        run: |
          echo "Downloading sources..."
          curl -L --retry 3 -o source_china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o source_hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o source_taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u
          curl -L --retry 3 -o epg.xml             http://epg.51zmt.top:8000/e.xml

      - name: Build Playlist
        run: |
          # 1. åˆå§‹åŒ–
          echo "#EXTM3U" > playlist.m3u
          touch valid_raw_data.txt
          
          PROVINCES="åŒ—äº¬ ä¸Šæµ· å¤©æ´¥ é‡åº† æ²³åŒ— å±±è¥¿ å†…è’™å¤ è¾½å® å‰æ— é»‘é¾™æ±Ÿ æ±Ÿè‹ æµ™æ±Ÿ å®‰å¾½ ç¦å»º æ±Ÿè¥¿ å±±ä¸œ æ²³å— æ¹–åŒ— æ¹–å— å¹¿ä¸œ å¹¿è¥¿ æµ·å— å››å· è´µå· äº‘å— è¥¿è— é™•è¥¿ ç”˜è‚ƒ é’æµ· å®å¤ æ–°ç–†"

          # å½’ä¸€åŒ– ID å‡½æ•° (ç”¨äºåˆå¹¶åŒåé¢‘é“)
          normalize_id() {
              echo "$1" | sed -E 's/\[[^]]*\]//g; s/\([^)]*\)//g; s/(é«˜æ¸…|HD|è¶…æ¸…|UHD|4K|FHD|æ ‡æ¸…|SD)//ig' | tr -d ' \-()ï¼ˆï¼‰' | tr '[:lower:]' '[:upper:]'
          }

          # 2. éå†å¹¶æµ‹é€Ÿ
          collect_and_test () {
            local AREA=$1
            local FILE=$2
            echo "Testing $AREA..."
            awk '/^#EXTINF/ {info=$0; getline url; if (url ~ /^http/) print info "\t" url}' "$FILE" | while IFS=$'\t' read -r INFO URL; do
              CHECK_RESULT=$(curl -s -w "%{http_code}\t%{speed_download}" -o /dev/null --connect-timeout 3 --max-time 5 "$URL" || echo -e "000\t0")
              HTTP_CODE=$(echo "$CHECK_RESULT" | cut -f1)
              SPEED=$(echo "$CHECK_RESULT" | cut -f2)

              if [[ "$HTTP_CODE" == "200" ]]; then
                  echo -e "${SPEED}\t${AREA}\t${URL}\t${INFO}" >> valid_raw_data.txt
              fi
            done
          }

          collect_and_test "China" "source_china.m3u"
          collect_and_test "Hong Kong" "source_hongkong.m3u"
          collect_and_test "Taiwan" "source_taiwan.m3u"

          # 3. æ¸…æ´—åç§°ã€ç­›é€‰ Top 5
          echo "Cleaning names and selecting top 5..."
          while IFS=$'\t' read -r SPEED AREA URL INFO; do
              RAW_NAME=$(echo "$INFO" | sed 's/.*,//')
              # æ¸…ç†æ˜¾ç¤ºåç§° (ç§»é™¤ [BD] ç­‰)
              CLEAN_NAME=$(echo "$RAW_NAME" | sed -E 's/\[[^]]*\]//g' | sed -E 's/^[[:space:]\-]+|[[:space:]\-]+$//g')
              MID=$(normalize_id "$CLEAN_NAME")
              
              GROUP="å…¶ä»–"
              if [[ "$AREA" == "China" ]]; then
                  GROUP="ä¸­å›½: å…¨å›½"
                  for P in $PROVINCES; do
                      if [[ "$CLEAN_NAME" == *"$P"* ]]; then GROUP="ä¸­å›½: $P"; break; fi
                  done
              elif [[ "$AREA" == "Hong Kong" ]]; then GROUP="é¦™æ¸¯"
              elif [[ "$AREA" == "Taiwan" ]]; then GROUP="å°æ¹¾"
              fi
              echo -e "${MID}\t${SPEED}\t${GROUP}\t${CLEAN_NAME}\t${URL}" >> pre_sort.txt
          done < valid_raw_data.txt

          sort -t $'\t' -k1,1 -k2,2nr pre_sort.txt | \
          awk -F '\t' '{ if (count[$1] < 5) { print; count[$1]++; } }' > final_list.txt

          # 4. EPG æ˜ å°„
          declare -A EPG_MAP
          while IFS='|' read -r ID NAME; do
              [[ -n "$NAME" ]] && EPG_MAP["$NAME"]="$ID"
          done < <(grep 'channel id' epg.xml | sed -n 's/.*id="\([^"]*\)".*display-name="\([^"]*\)".*/\1|\2/p')

          # 5. ç”Ÿæˆæœ€ç»ˆ M3U
          CURRENT_GROUP=""
          sort -t $'\t' -k3,3 -k4,4 final_list.txt | while IFS=$'\t' read -r MID SPEED GROUP NAME URL; do
              if [[ "$GROUP" != "$CURRENT_GROUP" ]]; then
                  echo -e "\n# ===== $GROUP =====" >> playlist.m3u
                  CURRENT_GROUP="$GROUP"
              fi
              ICON_NAME=$(echo "$NAME" | tr -dc '[:alnum:]')
              TVG_ID=${EPG_MAP[$NAME]}
              
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              EXT="${EXT} tvg-logo=\"https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${ICON_NAME}.png\""
              EXT="${EXT} group-title=\"${GROUP}\",${NAME}"
              
              echo "$EXT" >> playlist.m3u
              echo "$URL" >> playlist.m3u
          done

          # 6. å®‰å…¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ (ä¸å†ä½¿ç”¨ rm *.m3u)
          rm -f source_*.m3u epg.xml valid_raw_data.txt pre_sort.txt final_list.txt

      - name: Commit and Push Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          if git diff --quiet playlist.m3u; then
            echo "No changes detected."
          else
            git add playlist.m3u
            git commit -m "ğŸš€ Update: Top 5 Speed & Cleaned Names ($(date +'%Y-%m-%d %H:%M'))"
            git pull --rebase origin main
            git push
          fi
