name: IPTV Auto Builder Pro

on:
  schedule:
    # æ¯ 4 å°æ—¶è¿è¡Œä¸€æ¬¡ (æ¨™æº– Cron èªæ³•)
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # 2. å®‰è£…å¿…éœ€å·¥å…·
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl 

      # 3. ä¸‹è½½ M3U æºåˆ—è¡¨
      - name: Download Source Lists
        run: |
          echo "Downloading M3U sources..."
          curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u

      # 4. ä¸‹è½½ EPG
      - name: Download EPG
        run: |
          echo "Downloading EPG file..."
          curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

      # 5. ç”Ÿæˆ playlist
      - name: Build Playlist
        run: |
          # 1. åˆå§‹åŒ–å’Œæº–å‚™æ•¸æ“š
          echo "#EXTM3U" > playlist.m3u
          touch valid_channels.txt
          
          # è²æ˜çœä»½æ˜ å°„ (Province Map)
          declare -A PROVINCE_MAP=( 
            ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" 
            ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["InnerMongolia"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" 
            ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" 
            ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" 
            ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" 
            ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" 
            ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" 
            ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†" 
          )
          
          # === é—œéµï¼šæ­£è¦åŒ–å‡½æ•¸ (Normalization) ===
          normalize_name() {
              local name="$1"
              
              # 1. ç§»é™¤æ–¹æ‹¬è™Ÿ [] åŠå…¶å…§éƒ¨åŒ…å«çš„æ‰€æœ‰å…§å®¹
              name=$(echo "$name" | sed -E 's/\[[^]]*\]//g')
              
              # 2. ç§»é™¤å¸¸è¦‹å“è³ªå¾Œç¶´
              name=$(echo "$name" | sed -E 's/( )?(\(|\[)(é«˜æ¸…|HD|è¶…æ¸…|UHD|4K|FHD|æ¨™æ¸…|æ ‡æ¸…|SD)(\)|\])//ig')
              name=$(echo "$name" | sed -E 's/( )?(é«˜æ¸…|HD|è¶…æ¸…|UHD|4K|FHD|æ¨™æ¸…|æ ‡æ¸…|SD)//ig')
              
              # 3. ç§»é™¤åœ“æ‹¬è™Ÿã€ç©ºæ ¼ã€ä¸¦å»é™¤é¦–å°¾å¤šé¤˜ç¬¦è™Ÿ
              name=$(echo "$name" | tr -d ' ' | tr -d '()' | sed -E 's/^-+//; s/-+$//')
              echo "$name"
          }

          # å®šç¾©ä¸²è¡Œè™•ç†å‡½æ•¸
          collect_channels () {
            AREA=$1
            FILE=$2

            echo "Processing $AREA from $FILE..."

            awk -v area="$AREA" '
              /^#EXTINF/ {
                info=$0;
                getline url;
                if (url ~ /^http/) {
                    print info "\t" url "\t" area;
                }
              }
            ' "$FILE" | while IFS=$'\t' read -r INFO URL AREA; do
              
              ORIGINAL_NAME=$(echo "$INFO" | sed 's/.*,//')
              NORMALIZED_NAME=$(normalize_name "$ORIGINAL_NAME")

              # === æ ¸å¿ƒï¼šä¸²è¡Œæ¸¬é€Ÿ - ä½¿ç”¨ time_connect å’Œ speed_download ===
              # è¼¸å‡ºæ ¼å¼: http_code time_connect speed_download (å­—ç¯€/ç§’)
              CHECK_RESULT=$(curl -s -w "%{http_code} %{time_connect} %{speed_download}" -o /dev/null --connect-timeout 3 --max-time 5 "$URL" || echo "000 999 0")
              
              HTTP_CODE=$(echo "$CHECK_RESULT" | awk '{print $1}')
              TIME_CONNECT=$(echo "$CHECK_RESULT" | awk '{print $2}')
              SPEED_DOWNLOAD=$(echo "$CHECK_RESULT" | awk '{print $3}')

              # åªä¿ç•™ HTTP 200 çš„ç·šè·¯
              if [[ "$HTTP_CODE" == "200" ]]; then
                  # æ ¼å¼: TIME_CONNECT [TAB] SPEED_DOWNLOAD [TAB] NORMALIZED_NAME [TAB] URL [TAB] AREA [TAB] åŸå§‹ä¿¡æ¯
                  echo -e "${TIME_CONNECT}\t${SPEED_DOWNLOAD}\t${NORMALIZED_NAME}\t${URL}\t${AREA}\t${INFO}" >> valid_channels.txt
              fi

            done
          }

          # 2. ä¸²è¡Œæ”¶é›†æ‰€æœ‰é »é“çš„æ¸¬é€Ÿæ•¸æ“š
          collect_channels "China" "china.m3u"
          collect_channels "Hong Kong" "hongkong.m3u"
          collect_channels "Taiwan" "taiwan.m3u"

          echo "Total valid channels found: $(wc -l valid_channels.txt)"


          # 3. ã€é—œéµä¿®æ”¹ã€‘æ’åºèˆ‡æ“‡å„ª (é¸æ“‡ä¸‹è¼‰é€Ÿåº¦æœ€é«˜çš„ Top 5)
          echo "Sorting and Selecting best sources (Top 5 per normalized channel by SPEED_DOWNLOAD)..."
          
          # æ’åºè¦å‰‡ï¼šæŒ‰æ­£è¦åŒ–åç¨±åˆ†çµ„(-k3,3)ï¼Œç„¶å¾ŒæŒ‰ä¸‹è¼‰é€Ÿåº¦æ•¸å­—é™åºæ’åº(-k2,2nr)
          sort -t $'\t' -k3,3 -k2,2nr valid_channels.txt | \
          # ã€æ ¸å¿ƒæ›´æ”¹ã€‘ï¼šä¿ç•™æ¯å€‹æ­£è¦åŒ–é »é“åç¨±çš„ TOP 5 è¨˜éŒ„
          awk -F '\t' '{ if (count[$3] < 5) { print; count[$3]++; } }' > best_channels.txt

          echo "Selected $(wc -l best_channels.txt) unique fastest sources (Max 5 per channel)."


          # 4. EPG æŸ¥æ‰¾ä¼˜åŒ–
          declare -A EPG_MAP
          echo "Building EPG map..."
          grep 'channel id' epg.xml | while IFS= read -r LINE; do
              TVG_ID=$(echo "$LINE" | sed -n 's/.*id="\([^"]*\)".*/\1/p')
              CHANNEL_NAME=$(echo "$LINE" | sed -n 's/.*display-name="\([^"]*\)".*/\1/p')
              if [[ -n "$TVG_ID" && -n "$CHANNEL_NAME" ]]; then
                  EPG_MAP["$CHANNEL_NAME"]="$TVG_ID"
              fi
          done


          # 5. å¯«å…¥æœ€çµ‚ M3U æ–‡ä»¶ (å¾ best_channels.txt è®€å–)
          declare CURRENT_GROUP="" 
          
          write_playlist() {
            # å¾ best_channels.txt è®€å–æ‰€æœ‰æœ€å„ªç·šè·¯ã€‚
            # æ’åºéµï¼šæŒ‰ AREA (ç¬¬ 5 æ¬„) å’Œ NORMALIZED_NAME (ç¬¬ 3 æ¬„) æ’åº
            sort -t $'\t' -k5,5 -k3,3 best_channels.txt | while IFS=$'\t' read -r TIME_CONNECT SPEED_DOWNLOAD NORMALIZED_NAME URL AREA INFO; do
              
              DISPLAY_NAME=$(echo "$INFO" | sed 's/.*,//')

              # === åˆ¤æ–· Group Title (æ ¸å¿ƒé‚è¼¯) ===
              GROUP_TITLE=""
              if [[ "$AREA" == "China" ]]; then
                PROVINCE_KEY=$(echo "$DISPLAY_NAME" | awk '{print $1}')
                PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]}
                
                if [[ -n "$PROVINCE_CH" ]]; then
                  GROUP_TITLE="ä¸­å›½: ${PROVINCE_CH}"
                else
                  # å¦‚æœç„¡æ³•è­˜åˆ¥çœä»½ï¼Œæ­¸é¡åˆ° "å…¨å›½"
                  GROUP_TITLE="ä¸­å›½: å…¨å›½"
                fi
              elif [[ "$AREA" == "Hong Kong" ]]; then
                GROUP_TITLE="é¦™æ¸¯"
              elif [[ "$AREA" == "Taiwan" ]]; then
                GROUP_TITLE="å°æ¹¾"
              else
                GROUP_TITLE="$AREA"
              fi

              # æª¢æŸ¥æ˜¯å¦éœ€è¦æ’å…¥æ–°çš„åˆ†çµ„æ¨™é¡Œ
              if [[ "$GROUP_TITLE" != "$CURRENT_GROUP" ]]; then
                  echo "" >> playlist.m3u
                  echo "# ===== $GROUP_TITLE =====" >> playlist.m3u
                  CURRENT_GROUP="$GROUP_TITLE"
              fi

              # === æ§‹å»º M3U EXTINF æ¨™ç±¤ ===
              CLEAN_NAME=$(echo "$DISPLAY_NAME" | tr -dc '[:alnum:][:alpha:]')
              LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
              TVG_ID=${EPG_MAP[$DISPLAY_NAME]}
              
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              EXT="${EXT} tvg-logo=\"${LOGO_URL}\""
              EXT="${EXT} group-title=\"${GROUP_TITLE}\",${DISPLAY_NAME}"
              
              echo "$EXT" >> playlist.m3u
              echo "$URL" >> playlist.m3u
            done
          }
          
          # èª¿ç”¨å¯«å…¥å‡½æ•¸
          write_playlist
          
          echo "Final playlist generated."
          # æ¸…ç†è‡¨æ™‚æ–‡ä»¶
          rm valid_channels.txt best_channels.txt epg.xml


      # 6. Commit & Push
      - name: Commit and Push Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          if git diff --quiet playlist.m3u; then
            echo "No changes detected. Skipping commit."
          else
            git add playlist.m3u
            git commit -m "ğŸš€ Update playlist (Top 5 Speed, Normalized & Grouped): $(date +'%Y-%m-%d %H:%M:%S')" 
            git push
          fi
