name: IPTV Auto Builder Pro

on:
  schedule:
    # æ¯ 4 å°æ—¶è¿è¡Œä¸€æ¬¡ (ä¿®æ­£åçš„æ ‡å‡† Cron)
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # 2. å®‰è£…å¿…éœ€å·¥å…·
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl gawk

      # 3. ä¸‹è½½æ•°æ® (M3U å’Œ EPG)
      - name: Download Data
        run: |
          echo "Downloading sources..."
          curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u
          curl -L --retry 3 -o epg.xml      http://epg.51zmt.top:8000/e.xml

      # 4. æ ¸å¿ƒå¤„ç†é€»è¾‘
      - name: Build Playlist
        run: |
          # åˆå§‹åŒ–
          echo "#EXTM3U" > playlist.m3u
          touch valid_raw_data.txt
          
          # çœä»½åˆ—è¡¨ (ç”¨äºåç»­ä¸­æ–‡å…³é”®å­—åŒ¹é…)
          PROVINCES="åŒ—äº¬ ä¸Šæµ· å¤©æ´¥ é‡åº† æ²³åŒ— å±±è¥¿ å†…è’™å¤ è¾½å® å‰æ— é»‘é¾™æ±Ÿ æ±Ÿè‹ æµ™æ±Ÿ å®‰å¾½ ç¦å»º æ±Ÿè¥¿ å±±ä¸œ æ²³å— æ¹–åŒ— æ¹–å— å¹¿ä¸œ å¹¿è¥¿ æµ·å— å››å· è´µå· äº‘å— è¥¿è— é™•è¥¿ ç”˜è‚ƒ é’æµ· å®å¤ æ–°ç–†"

          # å½’ä¸€åŒ–å‡½æ•°ï¼šç”¨äºå°†ä¸åŒæ ¼å¼çš„é¢‘é“åè½¬åŒ–ä¸ºå”¯ä¸€ IDï¼ˆä¾‹å¦‚ [BD]CCTV-1 å’Œ CCTV1 éƒ½å˜æˆ CCTV1ï¼‰
          normalize_id() {
              echo "$1" | sed -E 's/\[[^]]*\]//g; s/\([^)]*\)//g; s/(é«˜æ¸…|HD|è¶…æ¸…|UHD|4K|FHD|æ ‡æ¸…|SD)//ig' | tr -d ' \-()ï¼ˆï¼‰' | tr '[:lower:]' '[:upper:]'
          }

          # === ç¬¬ä¸€æ­¥ï¼šéå†å¹¶æµ‹é€Ÿ (æå–æ‰€æœ‰åœ¨çº¿çš„æº) ===
          collect_and_test () {
            local AREA=$1
            local FILE=$2
            echo "Testing channels in $AREA..."
            
            # æå– #EXTINF å’Œ URL
            awk '/^#EXTINF/ {info=$0; getline url; if (url ~ /^http/) print info "\t" url}' "$FILE" | while IFS=$'\t' read -r INFO URL; do
              # æµ‹é€Ÿï¼šè¿æ¥è¶…æ—¶ 3sï¼Œæ€»è€—æ—¶ 5s
              CHECK_RESULT=$(curl -s -w "%{http_code}\t%{speed_download}" -o /dev/null --connect-timeout 3 --max-time 5 "$URL" || echo -e "000\t0")
              HTTP_CODE=$(echo "$CHECK_RESULT" | cut -f1)
              SPEED=$(echo "$CHECK_RESULT" | cut -f2)

              if [[ "$HTTP_CODE" == "200" ]]; then
                  # æš‚æ—¶ä¿å­˜åŸå§‹æ•°æ®ï¼šé€Ÿåº¦ | åœ°åŒº | URL | åŸå§‹ä¿¡æ¯
                  echo -e "${SPEED}\t${AREA}\t${URL}\t${INFO}" >> valid_raw_data.txt
              fi
            done
          }

          collect_and_test "China" "china.m3u"
          collect_and_test "Hong Kong" "hongkong.m3u"
          collect_and_test "Taiwan" "taiwan.m3u"

          # === ç¬¬äºŒæ­¥ï¼šæ¸…æ´—åç§°ã€å½’ä¸€åŒ–å¹¶ç­›é€‰ Top 5 ===
          echo "Cleaning names and selecting top 5 by speed..."
          
          while IFS=$'\t' read -r SPEED AREA URL INFO; do
              RAW_NAME=$(echo "$INFO" | sed 's/.*,//')
              
              # 1. å½»åº•æ¸…æ´—æ˜¾ç¤ºåç§°ï¼šå˜æˆ "CCTV-1" è¿™ç§å¹²å‡€æ ¼å¼
              CLEAN_NAME=$(echo "$RAW_NAME" | sed -E 's/\[[^]]*\]//g' | sed -E 's/^[[:space:]\-]+|[[:space:]\-]+$//g')
              
              # 2. ç”Ÿæˆå¯¹æ¯” IDï¼šç”¨äºåˆå¹¶åŒç±»é¡¹
              MID=$(normalize_id "$CLEAN_NAME")
              
              # 3. ç¡®å®šåˆ†ç»„ (Group Title)
              GROUP="å…¶ä»–"
              if [[ "$AREA" == "China" ]]; then
                  GROUP="ä¸­å›½: å…¨å›½"
                  for P in $PROVINCES; do
                      if [[ "$CLEAN_NAME" == *"$P"* ]]; then GROUP="ä¸­å›½: $P"; break; fi
                  done
              elif [[ "$AREA" == "Hong Kong" ]]; then GROUP="é¦™æ¸¯"
              elif [[ "$AREA" == "Taiwan" ]]; then GROUP="å°æ¹¾"
              fi

              # æ±‡æ€»å¾…æ’åºåˆ—ï¼šMID | SPEED | GROUP | CLEAN_NAME | URL
              echo -e "${MID}\t${SPEED}\t${GROUP}\t${CLEAN_NAME}\t${URL}" >> pre_sort.txt
          done < valid_raw_data.txt

          # æŒ‰ MID åˆ†ç»„å¹¶æŒ‰é€Ÿåº¦é™åºï¼Œå–æ¯ç»„å‰ 5
          sort -t $'\t' -k1,1 -k2,2nr pre_sort.txt | \
          awk -F '\t' '{ if (count[$1] < 5) { print; count[$1]++; } }' > final_list.txt

          # === ç¬¬ä¸‰æ­¥ï¼šæ„å»º EPG æ˜ å°„ (åŠ é€ŸæŸ¥æ‰¾) ===
          declare -A EPG_MAP
          echo "Building EPG Map..."
          while IFS='|' read -r ID NAME; do
              [[ -n "$NAME" ]] && EPG_MAP["$NAME"]="$ID"
          done < <(grep 'channel id' epg.xml | sed -n 's/.*id="\([^"]*\)".*display-name="\([^"]*\)".*/\1|\2/p')

          # === ç¬¬å››æ­¥ï¼šå†™å…¥ M3U (æŒ‰ç»„æ’åºé¿å…æ ‡é¢˜é‡å¤) ===
          echo "Generating final M3U..."
          CURRENT_GROUP=""
          # æ’åºä¾æ®ï¼šGroup(k3) -> Name(k4)
          sort -t $'\t' -k3,3 -k4,4 final_list.txt | while IFS=$'\t' read -r MID SPEED GROUP NAME URL; do
              if [[ "$GROUP" != "$CURRENT_GROUP" ]]; then
                  echo -e "\n# ===== $GROUP =====" >> playlist.m3u
                  CURRENT_GROUP="$GROUP"
              fi
              
              # ç”Ÿæˆå›¾æ ‡å’ŒæŸ¥æ‰¾ EPG
              ICON_NAME=$(echo "$NAME" | tr -dc '[:alnum:]')
              TVG_ID=${EPG_MAP[$NAME]}
              
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              EXT="${EXT} tvg-logo=\"https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${ICON_NAME}.png\""
              EXT="${EXT} group-title=\"${GROUP}\",${NAME}"
              
              echo "$EXT" >> playlist.m3u
              echo "$URL" >> playlist.m3u
          done

          # æ¸…ç†
          rm -f *.m3u epg.xml valid_raw_data.txt pre_sort.txt final_list.txt
          mv playlist.m3u backup_playlist.m3u && mv backup_playlist.m3u playlist.m3u

      # 5. Commit & Push
      - name: Commit and Push Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          if git diff --quiet playlist.m3u; then
            echo "No changes detected. Skipping commit."
          else
            git add playlist.m3u
            git commit -m "ğŸš€ Update: Top 5 Speed & Cleaned Names ($(date +'%Y-%m-%d %H:%M'))"
            
            # è¿™é‡Œçš„åŒæ­¥ç­–ç•¥ï¼šå¼ºåˆ¶æ‹‰å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹
            git pull --rebase origin main
            git push
          fi
