name: IPTV Auto Builder Pro

on:
schedule:
- cron: "0 */4 * * *"   # 每 4 小时自动更新
workflow_dispatch:

jobs:
build:
runs-on: ubuntu-latest

```
steps:
  # 1. Checkout repository 使用 PAT
  - name: Checkout repository
    uses: actions/checkout@v3
    with:
      token: ${{ secrets.PAT_TOKEN }}

  # 2. 安装必需工具
  - name: Install Tools
    run: |
      sudo apt-get update
      sudo apt-get install -y jq curl

  # 3. 下载 M3U 源列表
  - name: Download Source Lists
    run: |
      curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
      curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
      curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u

  # 4. 下载 EPG
  - name: Download EPG
    run: curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

  # 5. 生成 playlist
  - name: Build Playlist
    run: |
      mkdir -p output

      cat << 'EOF' > output/playlist.m3u
```

#EXTM3U
EOF

```
      declare -A seen_urls
      declare -A seen_names

      # 中文省份映射表
      declare -A PROVINCE_MAP=(
        ["Beijing"]="北京"
        ["Shanghai"]="上海"
        ["Tianjin"]="天津"
        ["Chongqing"]="重庆"
        ["Hebei"]="河北"
        ["Shanxi"]="山西"
        ["InnerMongolia"]="内蒙古"
        ["Liaoning"]="辽宁"
        ["Jilin"]="吉林"
        ["Heilongjiang"]="黑龙江"
        ["Jiangsu"]="江苏"
        ["Zhejiang"]="浙江"
        ["Anhui"]="安徽"
        ["Fujian"]="福建"
        ["Jiangxi"]="江西"
        ["Shandong"]="山东"
        ["Henan"]="河南"
        ["Hubei"]="湖北"
        ["Hunan"]="湖南"
        ["Guangdong"]="广东"
        ["Guangxi"]="广西"
        ["Hainan"]="海南"
        ["Sichuan"]="四川"
        ["Guizhou"]="贵州"
        ["Yunnan"]="云南"
        ["Tibet"]="西藏"
        ["Shaanxi"]="陕西"
        ["Gansu"]="甘肃"
        ["Qinghai"]="青海"
        ["Ningxia"]="宁夏"
        ["Xinjiang"]="新疆"
        ["HongKong"]="香港"
        ["Macau"]="澳门"
        ["Taiwan"]="台湾"
      )

      parse_area () {
        AREA=$1
        FILE=$2

        if [[ "$AREA" == "China" ]]; then
          echo "" >> output/playlist.m3u
          echo "# ===== 中国频道 =====" >> output/playlist.m3u
        elif [[ "$AREA" == "Hong Kong" ]]; then
          echo "" >> output/playlist.m3u
          echo "# ===== 香港频道 =====" >> output/playlist.m3u
        elif [[ "$AREA" == "Taiwan" ]]; then
          echo "" >> output/playlist.m3u
          echo "# ===== 台湾频道 =====" >> output/playlist.m3u
        fi

        awk '
          /^#EXTINF/ {
            info=$0;
            getline url;
            print info "\t" url;
          }
        ' "$FILE" | while IFS=$'\t' read -r INFO URL; do

          NAME=$(echo "$INFO" | sed 's/.*,//')
          CLEAN_NAME=$(echo "$NAME" | sed 's/[^[:alnum:]]//g')

          if [[ ${seen_urls[$URL]} || ${seen_names[$CLEAN_NAME]} ]]; then
            continue
          fi

          STATUS=$(curl -I --max-time 3 -o /dev/null -s -w "%{http_code}" "$URL" || echo "000")
          if [[ "$STATUS" != "200" ]]; then
            echo "跳过不可访问频道: $NAME ($URL)"
            continue
          fi

          seen_urls[$URL]=1
          seen_names[$CLEAN_NAME]=1

          LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
          if ! curl --output /dev/null --silent --head --fail "$LOGO_URL"; then
            LOGO_URL=""
          fi

          TVG_ID=$(grep -iF "$NAME" epg.xml | head -1 | sed -E 's/.*tvg-id="([^"]*)".*/\1/')

          if [[ "$AREA" == "China" ]]; then
            PROVINCE_KEY=$(echo "$NAME" | awk '{print $1}')
            PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]:-"未知"}
          else
            PROVINCE_CH=""
          fi

          EXT="#EXTINF:-1"
          [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
          [[ -n "$LOGO_URL" ]] && EXT="${EXT} tvg-logo=\"${LOGO_URL}\""

          if [[ -n "$PROVINCE_CH" ]]; then
            EXT="${EXT} group-title=\"中国: ${PROVINCE_CH}\",${NAME}"
          elif [[ "$AREA" == "Hong Kong" ]]; then
            EXT="${EXT} group-title=\"香港\",${NAME}"
          elif [[ "$AREA" == "Taiwan" ]]; then
            EXT="${EXT} group-title=\"台湾\",${NAME}"
          else
            EXT="${EXT} group-title=\"${AREA}\",${NAME}"
          fi

          echo "$EXT" >> output/playlist.m3u
          echo "$URL" >> output/playlist.m3u

        done
      }

      parse_area "China" china.m3u
      parse_area "Hong Kong" hongkong.m3u
      parse_area "Taiwan" taiwan.m3u

  # 6. Commit & Push
  - name: Commit Playlist
    run: |
      git config --global user.email "actions@github.com"
      git config --global user.name "GitHub Actions"
      git add output/playlist.m3u
      git diff --quiet || git commit -m "自动更新 playlist"
      git push
