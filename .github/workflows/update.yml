name: IPTV Auto Builder Pro

on:
  # è°ƒåº¦ä»»åŠ¡ï¼šæ¯ 4 å°æ—¶è‡ªåŠ¨æ›´æ–°
  schedule:
    - cron: "0 */4 * * *"
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository ä½¿ç”¨ PAT
      - name: ğŸ“¦ Checkout repository (using PAT)
        uses: actions/checkout@v3
        with:
          # ä½¿ç”¨ PAT å¯†é’¥ç¡®ä¿å¯ä»¥æ¨é€æ›´æ–°
          token: ${{ secrets.PAT_TOKEN }} 

      # 2. å®‰è£…å¿…éœ€å·¥å…·
      - name: ğŸ› ï¸ Install Tools (jq, curl)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # 3. ä¸‹è½½ M3U æºåˆ—è¡¨
      - name: â¬‡ï¸ Download Source Lists
        run: |
          echo "Downloading China, Hong Kong, and Taiwan M3U sources..."
          curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u
          
      # 4. ä¸‹è½½ EPG
      - name: â¬‡ï¸ Download EPG Data
        run: |
          echo "Downloading EPG file..."
          curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

      # 5. ç”Ÿæˆ playlist
      - name: âš™ï¸ Build and Filter Playlist
        # æ‰€æœ‰ Shell é€»è¾‘éƒ½æ”¾åœ¨è¿™ä¸ª run å—ä¸­
        run: |
          echo "Starting playlist build and filtering process..."
          mkdir -p output
          cat << 'EOF' > output/playlist.m3u
#EXTM3U
EOF

          # å£°æ˜ç”¨äºå»é‡å’Œæ˜ å°„çš„å…³è”æ•°ç»„
          declare -A seen_urls
          declare -A seen_names

          # ä¸­æ–‡çœä»½æ˜ å°„è¡¨
          declare -A PROVINCE_MAP=( 
            ["Beijing"]="åŒ—äº¬" 
            ["Shanghai"]="ä¸Šæµ·" 
            ["Hunan"]="æ¹–å—" 
            ["Guangdong"]="å¹¿ä¸œ" 
            ["Zhejiang"]="æµ™æ±Ÿ" 
            ["Jiangsu"]="æ±Ÿè‹" 
            ["Sichuan"]="å››å·" 
            ["Shandong"]="å±±ä¸œ" 
          )

          # å®šä¹‰å¤„ç†å‡½æ•°çš„é€»è¾‘
          parse_area () {
            AREA=$1
            FILE=$2

            if [[ "$AREA" == "China" ]]; then
              echo "" >> output/playlist.m3u
              echo "# ===== ä¸­å›½é¢‘é“ =====" >> output/playlist.m3u
            elif [[ "$AREA" == "Hong Kong" ]]; then
              echo "" >> output/playlist.m3u
              echo "# ===== é¦™æ¸¯é¢‘é“ =====" >> output/playlist.m3u
            elif [[ "$AREA" == "Taiwan" ]]; then
              echo "" >> output/playlist.m3u
              echo "# ===== å°æ¹¾é¢‘é“ =====" >> output/playlist.m3u
            fi

            # ä½¿ç”¨ awk æå– info å’Œ url
            awk '
              /^#EXTINF/ {
                info=$0;
                getline url;
                # ä»…å¤„ç†åŒ…å« http/https çš„ URLï¼Œé¿å…ç©ºè¡Œ
                if (url ~ /^http/) {
                    print info "\t" url;
                }
              }
            ' "$FILE" | while IFS=$'\t' read -r INFO URL; do

              # æå–é¢‘é“åç§°å¹¶è§„èŒƒåŒ–
              NAME=$(echo "$INFO" | sed 's/.*,//')
              CLEAN_NAME=$(echo "$NAME" | tr -dc '[:alnum:][:alpha:]')

              # æ£€æŸ¥æ˜¯å¦é‡å¤
              if [[ ${seen_urls[$URL]} || ${seen_names[$CLEAN_NAME]} ]]; then
                echo "Skipping duplicate: $NAME"
                continue
              fi

              # æ£€æŸ¥é“¾æ¥å¯ç”¨æ€§ (åªè·å– HTTP çŠ¶æ€ç )
              STATUS=$(curl -I --max-time 5 -o /dev/null -s -w "%{http_code}" "$URL" || echo "000")
              if [[ "$STATUS" != "200" ]]; then
                echo "Skipping unreachable: $NAME ($URL) - Status $STATUS"
                continue
              fi

              # æ ‡è®°ä¸ºå·²å¤„ç†
              seen_urls[$URL]=1
              seen_names[$CLEAN_NAME]=1

              # æŸ¥æ‰¾ Logo URL
              LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
              if ! curl --output /dev/null --silent --head --fail "$LOGO_URL"; then
                LOGO_URL="" # å¦‚æœ 404ï¼Œåˆ™æ¸…ç©º URL
              fi

              # æŸ¥æ‰¾ TVG ID
              TVG_ID=$(grep -iF "$NAME" epg.xml | head -1 | sed -n 's/.*tvg-id="\([^"]*\)".*/\1/p')

              # å¤„ç†ä¸­å›½é¢‘é“çš„åˆ†ç»„æ ‡é¢˜
              if [[ "$AREA" == "China" ]]; then
                # å°è¯•æå–çœä»½å…³é”®å­— (é€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªè¯)
                PROVINCE_KEY=$(echo "$NAME" | awk '{print $1}')
                PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]}
              else
                PROVINCE_CH=""
              fi

              # æ„å»º EXTFINF è¡Œ
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              [[ -n "$LOGO_URL" ]] && EXT="${EXT} tvg-logo=\"${LOGO_URL}\""

              if [[ -n "$PROVINCE_CH" ]]; then
                EXT="${EXT} group-title=\"ä¸­å›½: ${PROVINCE_CH}\",${NAME}"
              elif [[ "$AREA" == "Hong Kong" ]]; then
                EXT="${EXT} group-title=\"é¦™æ¸¯\",${NAME}"
              elif [[ "$AREA" == "Taiwan" ]]; then
                EXT="${EXT} group-title=\"å°æ¹¾\",${NAME}"
              else
                EXT="${EXT} group-title=\"${AREA}\",${NAME}"
              fi

              # å†™å…¥æœ€ç»ˆçš„ M3U å†…å®¹
              echo "$EXT" >> output/playlist.m3u
              echo "$URL" >> output/playlist.m3u

            done
          }

          # å¾ªç¯è°ƒç”¨å‡½æ•°å¤„ç†æ‰€æœ‰åŒºåŸŸ
          declare -A AREAS=( ["China"]="china.m3u" ["Hong Kong"]="hongkong.m3u" ["Taiwan"]="taiwan.m3u" )
          for AREA in "${!AREAS[@]}"; do
            parse_area "$AREA" "${AREAS[$AREA]}"
          done
          echo "Playlist build complete."

      # 6. Commit & Push
      - name: â¬†ï¸ Commit and Push Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®é™…å˜åŒ– (é˜²æ­¢ç©ºæäº¤)
          if git diff --quiet output/playlist.m3u; then
            echo "No changes in playlist.m3u. Skipping commit."
          else
            git add output/playlist.m3u
            git commit -m "ğŸ¤– Auto update playlist: $(date +%Y-%m-%d %H:%M:%S)" 
            git push
          fi
          echo "Commit and Push done."
