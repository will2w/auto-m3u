name: IPTV Auto Builder Pro

on:
  schedule:
    # æ¯ 4 å°æ—¶è¿è¡Œä¸€æ¬¡ (æ ‡å‡† Cron è¯­æ³•)
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3
        with:
          # ç¡®ä¿ PAT_TOKEN å…·æœ‰å†™å…¥æƒé™
          token: ${{ secrets.PAT_TOKEN }}

      # 2. å®‰è£…å¿…éœ€å·¥å…· (åŒ…å« GNU parallel)
      - name: ğŸ› ï¸ Install Tools (jq, curl, parallel)
        run: |
          sudo apt-get update
          # å®‰è£… parallel å®ç°å¹¶å‘æµ‹é€Ÿ
          sudo apt-get install -y jq curl parallel 

      # 3. ä¸‹è½½ M3U æºåˆ—è¡¨
      - name: â¬‡ï¸ Download Source Lists
        run: |
          echo "Downloading M3U sources..."
          curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u

      # 4. ä¸‹è½½ EPG
      - name: â¬‡ï¸ Download EPG
        run: |
          echo "Downloading EPG file..."
          curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

      # 5. ç”Ÿæˆ playlist (æ ¸å¿ƒä¼˜åŒ–æ­¥éª¤)
      - name: âš™ï¸ Build Playlist (Parallel Speed Test)
        run: |
          # 1. åˆå§‹åŒ–å’Œå‡†å¤‡æ•°æ®
          echo "#EXTM3U" > playlist.m3u
          touch all_channels_raw.txt
          touch valid_channels.txt
          
          # ã€ä¿®æ­£ã€‘å°†æ‰€æœ‰å‡½æ•°å’Œå˜é‡å®šä¹‰å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œç¡®ä¿ parallel å¯ä»¥ source
          cat > parallel_function.sh << 'EOF'
          # å®šä¹‰çœä»½æ˜ å°„
          declare -A PROVINCE_MAP=( 
            ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" 
            ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["InnerMongolia"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" 
            ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" 
            ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" 
            ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" 
            ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" 
            ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" 
            ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†" 
          )
          
          # å®šä¹‰å¤„ç†å•ä¸ª URL çš„å‡½æ•° (ä¼šè¢« parallel è°ƒç”¨)
          process_url() {
              LINE="$1"
              INFO=$(echo "$LINE" | awk -F'\t' '{print $1}')
              URL=$(echo "$LINE" | awk -F'\t' '{print $2}')
              AREA=$(echo "$LINE" | awk -F'\t' '{print $3}')
              NAME=$(echo "$INFO" | sed 's/.*,//')
              
              # æµ‹é€Ÿï¼Œå¹¶æ•è· HTTPçŠ¶æ€ç  å’Œ è€—æ—¶
              CHECK_RESULT=$(curl -s -w "%{http_code} %{time_total}" -o /dev/null --connect-timeout 3 --max-time 5 "$URL" || echo "000 999")
              
              HTTP_CODE=$(echo "$CHECK_RESULT" | awk '{print $1}')
              LATENCY=$(echo "$CHECK_RESULT" | awk '{print $2}')
          
              if [[ "$HTTP_CODE" == "200" ]]; then
                  # æ ¼å¼: è€—æ—¶ [TAB] åå­— [TAB] URL [TAB] åŒºåŸŸ [TAB] åŸå§‹ä¿¡æ¯
                  echo -e "${LATENCY}\t${NAME}\t${URL}\t${AREA}\t${INFO}"
              else
                  echo "Skipped: $NAME (Status $HTTP_CODE)" >&2 
              fi
          }

          # å®šä¹‰å†™åˆ—è¡¨çš„å‡½æ•° (ä¸éœ€è¦è¢« parallel è°ƒç”¨ï¼Œä½†åœ¨ main shell ä¸­éœ€è¦)
          write_playlist() {
            TARGET_AREA=$1
            TITLE_TEXT=$2
            
            echo "" >> playlist.m3u
            echo "# ===== $TITLE_TEXT =====" >> playlist.m3u
            
            # ä» best_channels.txt ä¸­è¯»å–å±äºå½“å‰åŒºåŸŸçš„é¢‘é“
            grep -E "\t$TARGET_AREA\t" best_channels.txt | while IFS=$'\t' read -r LATENCY NAME URL AREA INFO; do
              
              CLEAN_NAME=$(echo "$NAME" | tr -dc '[:alnum:][:alpha:]')
          
              # åŒ¹é… Logo (Logo URL æ£€æŸ¥åœ¨ä¸»è„šæœ¬ä¸­è¿›è¡Œ)
              LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
              
              # ä¼˜åŒ–ï¼šç›´æ¥ä» EPG_MAP ä¸­æŸ¥æ‰¾ TVG ID (EPG_MAP åœ¨ä¸»è„šæœ¬ä¸­æ„å»º)
              TVG_ID=${EPG_MAP[$NAME]}
          
              # å¤„ç†åˆ†ç»„æ ‡é¢˜
              PROVINCE_CH=""
              if [[ "$AREA" == "China" ]]; then
                PROVINCE_KEY=$(echo "$NAME" | awk '{print $1}')
                PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]}
              fi
          
              # æ„å»ºæ ‡ç­¾ (åŒ…å« Group-Title)
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              # Logo æ£€æŸ¥é€»è¾‘å¤æ‚ï¼Œä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬å…ˆå‡è®¾ Logo URL æ˜¯å­˜åœ¨çš„
              # å¦‚æœ curl --head æ£€æŸ¥åœ¨ä¸»è„šæœ¬å¾ªç¯ä¸­ï¼Œæ€§èƒ½ä¼šå¾ˆå·®ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ„å»º URL
              # å®é™… Logo æœ‰æ— çš„æ£€æŸ¥å¯ä»¥æ”¾åœ¨å¦å¤–çš„å®šæ—¶ä»»åŠ¡æˆ–ç›´æ¥ç§»é™¤ curl æ£€æŸ¥
              
              EXT="${EXT} tvg-logo=\"${LOGO_URL}\""
              
              if [[ -n "$PROVINCE_CH" ]]; then
                EXT="${EXT} group-title=\"ä¸­å›½: ${PROVINCE_CH}\",${NAME}"
              elif [[ "$AREA" == "Hong Kong" ]]; then
                EXT="${EXT} group-title=\"é¦™æ¸¯\",${NAME}"
              elif [[ "$AREA" == "Taiwan" ]]; then
                EXT="${EXT} group-title=\"å°æ¹¾\",${NAME}"
              else
                EXT="${EXT} group-title=\"${AREA}\",${NAME}"
              fi
              
              echo "$EXT" >> playlist.m3u
              echo "$URL" >> playlist.m3u
            done
          }
          EOF

          # å®šä¹‰ extract_and_tag å‡½æ•°ï¼Œç”¨äºåˆå¹¶ M3U æºæ–‡ä»¶
          extract_and_tag() {
              FILE=$1
              AREA=$2
              awk -v area="$AREA" '
                /^#EXTINF/ {
                    info=$0;
                    getline url;
                    if (url ~ /^http/) {
                        print info "\t" url "\t" area;
                    }
                }' "$FILE" >> all_channels_raw.txt
          }
          
          echo "Merging all M3U sources..."
          extract_and_tag "china.m3u" "China"
          extract_and_tag "hongkong.m3u" "Hong Kong"
          extract_and_tag "taiwan.m3u" "Taiwan"
          
          
          # 2. æ ¸å¿ƒä¼˜åŒ–ï¼šä½¿ç”¨ parallel è¿›è¡Œå¹¶å‘æµ‹é€Ÿ
          echo "Starting parallel speed test (Max 5s timeout per URL)..."
          
          # ã€å…³é”®ä¿®æ­£ã€‘ä½¿ç”¨ --source é€‰é¡¹ï¼Œè®© parallel å¯åŠ¨çš„å­è¿›ç¨‹åŠ è½½å‡½æ•°å®šä¹‰
          cat all_channels_raw.txt | parallel --source parallel_function.sh -j 32 process_url {} > valid_channels.txt
          
          echo "Parallel test finished. Total valid channels: $(wc -l valid_channels.txt)"
          
          
          # 3. æ’åºä¸å»é‡
          sort -t $'\t' -k2,2 -k1,1n valid_channels.txt | awk -F '\t' '!seen[$2]++' > best_channels.txt
          
          echo "Selected $(wc -l best_channels.txt) unique fastest sources."
          
          # 4. EPG æŸ¥æ‰¾ä¼˜åŒ– (é¢„å…ˆæå– EPG ID æ˜ å°„è¡¨)
          declare -A EPG_MAP
          echo "Building EPG map..."
          # å°† EPG_MAP å¡«å……åˆ°ä¸»è„šæœ¬ä¸­
          grep 'channel id' epg.xml | while IFS= read -r LINE; do
              TVG_ID=$(echo "$LINE" | sed -n 's/.*id="\([^"]*\)".*/\1/p')
              CHANNEL_NAME=$(echo "$LINE" | sed -n 's/.*display-name="\([^"]*\)".*/\1/p')
              if [[ -n "$TVG_ID" && -n "$CHANNEL_NAME" ]]; then
                  EPG_MAP["$CHANNEL_NAME"]="$TVG_ID"
              fi
          done
          
          # 5. å†™å…¥æœ€ç»ˆ M3U æ–‡ä»¶ (è°ƒç”¨ write_playlist)
          # æ³¨æ„ï¼šä¸ºäº†è®© write_playlist èƒ½ä½¿ç”¨ EPG_MAPï¼Œæˆ‘ä»¬éœ€è¦é‡æ–° source å®ƒæˆ–åœ¨ä¸»è„šæœ¬ä¸­å®šä¹‰å®ƒ
          # ç”±äº EPG_MAP æ˜¯åŠ¨æ€æ„å»ºçš„ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ä¸»è„šæœ¬ä¸­è¿›è¡Œå¾ªç¯çš„æ–¹å¼æ¥åˆ©ç”¨å®ƒã€‚

          # ã€é‡æ–°å®šä¹‰ write_playlist å‡½æ•°ã€‘åœ¨ä¸»è„šæœ¬ä¸­ï¼Œä»¥ä¾¿ä½¿ç”¨ EPG_MAP
          write_playlist() {
            TARGET_AREA=$1
            TITLE_TEXT=$2
            
            echo "" >> playlist.m3u
            echo "# ===== $TITLE_TEXT =====" >> playlist.m3u
            
            # ä½¿ç”¨ PROVINCE_MAPï¼ˆä»ä¸´æ—¶æ–‡ä»¶ä¸­å¤åˆ¶è¿‡æ¥ï¼‰
            declare -A PROVINCE_MAP=( 
              ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" 
              ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["InnerMongolia"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" 
              ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" 
              ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" 
              ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" 
              ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" 
              ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" 
              ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†" 
            )

            grep -E "\t$TARGET_AREA\t" best_channels.txt | while IFS=$'\t' read -r LATENCY NAME URL AREA INFO; do
              
              CLEAN_NAME=$(echo "$NAME" | tr -dc '[:alnum:][:alpha:]')
          
              LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
              # ä¼˜åŒ–ï¼šç›´æ¥ä» EPG_MAP ä¸­æŸ¥æ‰¾ TVG ID
              TVG_ID=${EPG_MAP[$NAME]}
          
              PROVINCE_CH=""
              if [[ "$AREA" == "China" ]]; then
                PROVINCE_KEY=$(echo "$NAME" | awk '{print $1}')
                PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]}
              fi
          
              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              # æ³¨æ„ï¼šè¿™é‡Œä¸å†è¿›è¡Œ curl --head æ£€æŸ¥ï¼Œå‡è®¾ Logo URL å­˜åœ¨ä»¥æé«˜é€Ÿåº¦
              EXT="${EXT} tvg-logo=\"${LOGO_URL}\""
              
              if [[ -n "$PROVINCE_CH" ]]; then
                EXT="${EXT} group-title=\"ä¸­å›½: ${PROVINCE_CH}\",${NAME}"
              elif [[ "$AREA" == "Hong Kong" ]]; then
                EXT="${EXT} group-title=\"é¦™æ¸¯\",${NAME}"
              elif [[ "$AREA" == "Taiwan" ]]; then
                EXT="${EXT} group-title=\"å°æ¹¾\",${NAME}"
              else
                EXT="${EXT} group-title=\"${AREA}\",${NAME}"
              fi
              
              echo "$EXT" >> playlist.m3u
              echo "$URL" >> playlist.m3u
            done
          }

          # æŒ‰é¡ºåºå†™å…¥ M3U æ–‡ä»¶
          write_playlist "China" "ä¸­å›½é¢‘é“"
          write_playlist "Hong Kong" "é¦™æ¸¯é¢‘é“"
          write_playlist "Taiwan" "å°æ¹¾é¢‘é“"
          
          echo "Final playlist generated."
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm all_channels_raw.txt valid_channels.txt best_channels.txt epg.xml parallel_function.sh


      # 6. Commit & Push (ä¿®æ­£ date è¯­æ³•)
      - name: â¬†ï¸ Commit and Push Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
          if git diff --quiet playlist.m3u; then
            echo "No changes detected. Skipping commit."
          else
            git add playlist.m3u
            # ã€å…³é”®ä¿®æ­£ã€‘date æ ¼å¼å­—ç¬¦ä¸²å¤–å›´æ·»åŠ å•å¼•å·ï¼Œä¿®å¤ 'extra operand' é”™è¯¯
            git commit -m "ğŸš€ Update playlist (Optimized Speed): $(date +'%Y-%m-%d %H:%M:%S')" 
            # è§£å†³ 403 æƒé™é—®é¢˜ï¼Œç¡®ä¿ PAT_TOKEN æƒé™è¶³å¤Ÿ
            git push
          fi
