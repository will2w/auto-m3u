name: IPTV Auto Builder Pro

on:
  schedule:
    - cron: "*/240 * * * *"   # 每 4 小時自動更新
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository (使用 PAT)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # 2. Install required tools
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # 3. Download Source Lists
      - name: Download Source Lists
        run: |
          curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u

      # 4. Download EPG
      - name: Download EPG
        run: curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

      # 5. Build Playlist
      - name: Build Playlist
        run: |
          mkdir -p output
          echo "#EXTM3U" > output/playlist.m3u

          declare -A seen_urls
          declare -A seen_names

          parse_area () {
            AREA=$1
            FILE=$2
            echo "" >> output/playlist.m3u
            echo "# ===== ${AREA} Channels =====" >> output/playlist.m3u

            awk '
              /^#EXTINF/ {
                info=$0;
                getline url;
                print info "\t" url;
              }
            ' "$FILE" | while IFS=$'\t' read -r INFO URL; do

              NAME=$(echo "$INFO" | sed 's/.*,//')
              CLEAN_NAME=$(echo "$NAME" | tr -dc 'A-Za-z0-9')

              if [[ ${seen_urls[$URL]} || ${seen_names[$CLEAN_NAME]} ]]; then
                continue
              fi

              STATUS=$(curl -I --max-time 3 -o /dev/null -s -w "%{http_code}" "$URL" || echo "000")
              if [[ "$STATUS" != "200" ]]; then
                echo "Skipping $NAME ($URL)"
                continue
              fi

              seen_urls[$URL]=1
              seen_names[$CLEAN_NAME]=1

              LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
              if ! curl --output /dev/null --silent --head --fail "$LOGO_URL"; then
                LOGO_URL=""
              fi

              TVG_ID=$(grep -iF "$NAME" epg.xml | head -1 | sed -n 's/.*tvg-id="\([^"]*\)".*/\1/p')

              EXT="#EXTINF:-1"
              [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
              [[ -n "$LOGO_URL" ]] && EXT="${EXT} tvg-logo=\"${LOGO_URL}\""
              EXT="${EXT} group-title=\"${AREA}\",${NAME}"

              echo "$EXT" >> output/playlist.m3u
              echo "$URL" >> output/playlist.m3u

            done
          }

          parse_area "China" china.m3u
          parse_area "Hong Kong" hongkong.m3u
          parse_area "Taiwan" taiwan.m3u

      # 6. Commit and Push Playlist
      - name: Commit Playlist
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add output/playlist.m3u
          git commit -m "Auto update playlist" || echo "No change"
          git push origin main
