name: IPTV Auto Builder Pro

on:
schedule:
- cron: "0 */4 * * *"   # æ¯ 4 å°æ—¶è‡ªåŠ¨æ›´æ–°
workflow_dispatch:

jobs:
build:
runs-on: ubuntu-latest

```
steps:
  # 1. Checkout repository ä½¿ç”¨ PAT
  - name: Checkout repository
    uses: actions/checkout@v3
    with:
      token: ${{ secrets.PAT_TOKEN }}

  # 2. å®‰è£…å¿…éœ€å·¥å…·
  - name: ğŸ› ï¸ Install Tools (jq, curl, bc)
    run: |
      sudo apt-get update
      sudo apt-get install -y jq curl bc

  # 3. ä¸‹è½½ M3U æºåˆ—è¡¨
  - name: â¬‡ï¸ Download Source Lists
    run: |
      echo "Downloading China, Hong Kong, and Taiwan M3U sources..."
      curl -L --retry 3 -o china.m3u    https://freetv.fun/test_channels_china_new.m3u
      curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
      curl -L --retry 3 -o taiwan.m3u   https://freetv.fun/test_channels_taiwan_new.m3u

  # 4. ä¸‹è½½ EPG
  - name: â¬‡ï¸ Download EPG Data
    run: |
      echo "Downloading EPG file..."
      curl -L --retry 3 -o epg.xml http://epg.51zmt.top:8000/e.xml

  # 5. ç”Ÿæˆ playlist
  - name: Build Playlist
    run: |
      mkdir -p output
      cat << 'EOF' > output/playlist.m3u
```

#EXTM3U
EOF

```
      declare -A seen_urls
      declare -A seen_names
      declare -A PROVINCE_MAP=( 
        ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["InnerMongolia"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†" ["HongKong"]="é¦™æ¸¯" ["Macau"]="æ¾³é—¨" ["Taiwan"]="å°æ¹¾" 
      )

      parse_area () {
        AREA=$1
        FILE=$2

        if [[ "$AREA" == "China" ]]; then
          echo "" >> output/playlist.m3u
          echo "# ===== ä¸­å›½é¢‘é“ =====" >> output/playlist.m3u
        elif [[ "$AREA" == "Hong Kong" ]]; then
          echo "" >> output/playlist.m3u
          echo "# ===== é¦™æ¸¯é¢‘é“ =====" >> output/playlist.m3u
        elif [[ "$AREA" == "Taiwan" ]]; then
          echo "" >> output/playlist.m3u
          echo "# ===== å°æ¹¾é¢‘é“ =====" >> output/playlist.m3u
        fi

        awk '
          /^#EXTINF/ {
            info=$0;
            getline url;
            if (url ~ /^http/) { print info "\t" url }
          }
        ' "$FILE" | while IFS=$'\t' read -r INFO URL; do
          NAME=$(echo "$INFO" | sed 's/.*,//')
          CLEAN_NAME=$(echo "$NAME" | tr -dc '[:alnum:]')

          if [[ ${seen_urls[$URL]} || ${seen_names[$CLEAN_NAME]} ]]; then
            continue
          fi

          STATUS=$(curl -I --max-time 5 -o /dev/null -s -w "%{http_code}" "$URL" || echo "000")
          if [[ "$STATUS" != "200" ]]; then
            continue
          fi

          seen_urls[$URL]=1
          seen_names[$CLEAN_NAME]=1

          LOGO_URL="https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${CLEAN_NAME}.png"
          if ! curl --output /dev/null --silent --head --fail "$LOGO_URL"; then
            LOGO_URL=""
          fi

          TVG_ID=$(grep -iF "$NAME" epg.xml | head -1 | sed -n 's/.*tvg-id="\([^"]*\)".*/\1/p')

          if [[ "$AREA" == "China" ]]; then
            PROVINCE_KEY=$(echo "$NAME" | awk '{print $1}')
            PROVINCE_CH=${PROVINCE_MAP[$PROVINCE_KEY]}
          else
            PROVINCE_CH=""
          fi

          EXT="#EXTINF:-1"
          [[ -n "$TVG_ID" ]] && EXT="${EXT} tvg-id=\"${TVG_ID}\""
          [[ -n "$LOGO_URL" ]] && EXT="${EXT} tvg-logo=\"${LOGO_URL}\""

          if [[ -n "$PROVINCE_CH" ]]; then
            EXT="${EXT} group-title=\"ä¸­å›½: ${PROVINCE_CH}\",${NAME}"
          elif [[ "$AREA" == "Hong Kong" ]]; then
            EXT="${EXT} group-title=\"é¦™æ¸¯\",${NAME}"
          elif [[ "$AREA" == "Taiwan" ]]; then
            EXT="${EXT} group-title=\"å°æ¹¾\",${NAME}"
          else
            EXT="${EXT} group-title=\"${AREA}\",${NAME}"
          fi

          echo "$EXT" >> output/playlist.m3u
          echo "$URL" >> output/playlist.m3u
        done
      }

      declare -A AREAS=( ["China"]="china.m3u" ["Hong Kong"]="hongkong.m3u" ["Taiwan"]="taiwan.m3u" )
      for AREA in "${!AREAS[@]}"; do
        parse_area "$AREA" "${AREAS[$AREA]}"
      done
      echo "Playlist build complete."

  # 6. Commit & Push
  - name: â¬†ï¸ Commit and Push Playlist
    run: |
      git config --global user.email "actions@github.com"
      git config --global user.name "GitHub Actions"
      git add output/playlist.m3u
      git commit -m "ğŸ¤– Auto update playlist: $(date +%Y-%m-%d %H:%M:%S)" --allow-empty
      git push
