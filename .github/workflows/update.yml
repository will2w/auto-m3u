name: IPTV Auto Builder Pro

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl sed

      - name: Download Sources
        run: |
          echo "æ­£åœ¨ä¸‹è½½ M3U æº..."
          curl -L --retry 3 -o china.m3u https://freetv.fun/test_channels_china_new.m3u
          curl -L --retry 3 -o hongkong.m3u https://freetv.fun/test_channels_hong_kong_new.m3u
          curl -L --retry 3 -o taiwan.m3u https://freetv.fun/test_channels_taiwan_new.m3u

      - name: Build Playlist
        run: |
          echo "#EXTM3U x-tvg-url=\"http://epg.51zmt.top:8000/e.xml\"" > playlist.m3u
          > valid_channels.txt
          
          # çœä»½æ˜ å°„è¡¨
          declare -A PROVINCE_MAP=(
            ["Beijing"]="åŒ—äº¬" ["Shanghai"]="ä¸Šæµ·" ["Tianjin"]="å¤©æ´¥" ["Chongqing"]="é‡åº†" 
            ["Hebei"]="æ²³åŒ—" ["Shanxi"]="å±±è¥¿" ["Inner"]="å†…è’™å¤" ["Liaoning"]="è¾½å®" 
            ["Jilin"]="å‰æ—" ["Heilongjiang"]="é»‘é¾™æ±Ÿ" ["Jiangsu"]="æ±Ÿè‹" ["Zhejiang"]="æµ™æ±Ÿ" 
            ["Anhui"]="å®‰å¾½" ["Fujian"]="ç¦å»º" ["Jiangxi"]="æ±Ÿè¥¿" ["Shandong"]="å±±ä¸œ" 
            ["Henan"]="æ²³å—" ["Hubei"]="æ¹–åŒ—" ["Hunan"]="æ¹–å—" ["Guangdong"]="å¹¿ä¸œ" 
            ["Guangxi"]="å¹¿è¥¿" ["Hainan"]="æµ·å—" ["Sichuan"]="å››å·" ["Guizhou"]="è´µå·" 
            ["Yunnan"]="äº‘å—" ["Tibet"]="è¥¿è—" ["Shaanxi"]="é™•è¥¿" ["Gansu"]="ç”˜è‚ƒ" 
            ["Qinghai"]="é’æµ·" ["Ningxia"]="å®å¤" ["Xinjiang"]="æ–°ç–†"
          )

          # --- æ ¸å¿ƒå¤„ç†é€»è¾‘ ---
          collect_channels () {
            local AREA=$1
            local FILE=$2
            [ ! -f "$FILE" ] && return
            echo "æ­£åœ¨å¤„ç†åŒºåŸŸ: $AREA ..."

            grep "#EXTINF" "$FILE" | while read -r LINE; do
                ORIG_NAME=$(echo "$LINE" | sed 's/.*,//')
                URL=$(grep -A 1 "$LINE" "$FILE" | grep "http" | head -n 1)
                
                [ -z "$URL" ] && continue

                # 1. è¿‡æ»¤è´­ç‰©ç­‰é»‘åå•
                if [[ "$ORIG_NAME" =~ "è´­ç‰©" || "$ORIG_NAME" =~ "å•†åŸ" || "$ORIG_NAME" =~ "æµ‹è¯•" || "$ORIG_NAME" =~ "ä»·" ]]; then
                    continue
                fi

                # 2. ã€å…ˆå»æ‰å‰ç¼€ã€‘ï¼šå»æ‰æœ€å‰é¢çš„ [æ–¹æ‹¬å·] åŠå…¶å†…å®¹ï¼Œä¿ç•™åé¢åç¼€
                FINAL_NAME=$(echo "$ORIG_NAME" | sed -E 's/^\[[^]]*\]//g' | sed -E 's/^[[:space:]]*//; s/[[:space:]]*$//')

                # 3. æµ‹é€Ÿ
                CHECK=$(curl -I -s -w "%{http_code} %{time_connect} %{speed_download}" -o /dev/null --connect-timeout 2 --max-time 4 "$URL" || echo "000 0 0")
                HTTP_CODE=$(echo $CHECK | awk '{print $1}')
                
                if [ "$HTTP_CODE" = "200" ]; then
                    TIME_CONN=$(echo $CHECK | awk '{print $2}')
                    SPEED_DL=$(echo $CHECK | awk '{print $3}')
                    # å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼šè¿æ¥æ—¶é—´ [TAB] ä¸‹è½½é€Ÿåº¦ [TAB] å»å‰ç¼€åçš„åå­— [TAB] URL [TAB] åŒºåŸŸ
                    echo -e "${TIME_CONN}\t${SPEED_DL}\t${FINAL_NAME}\t${URL}\t${AREA}" >> valid_channels.txt
                fi
            done
          }

          # æ‰§è¡Œé‡‡é›†
          collect_channels "China" "china.m3u"
          collect_channels "Hong Kong" "hongkong.m3u"
          collect_channels "Taiwan" "taiwan.m3u"

          # --- 4. ã€åç­›é€‰é€Ÿåº¦ã€‘ï¼šæŒ‰å»æ‰å‰ç¼€åçš„åå­—åˆ†ç»„ï¼Œå–æ¯ç»„ä¸‹è½½é€Ÿåº¦æœ€å¿«çš„å‰ 5 å ---
          if [ -s valid_channels.txt ]; then
              # æ’åºè§„åˆ™ï¼šæŒ‰ç¬¬3åˆ—(åå­—)æ’åºï¼ŒåŒåä¸‹æŒ‰ç¬¬2åˆ—(é€Ÿåº¦)æ•°å­—å€’åºæ’
              sort -t$'\t' -k3,3 -k2,2nr valid_channels.txt | awk -F'\t' '!x[$3]++ || count[$3]++ < 5' > best_channels.txt
          else
              touch best_channels.txt
          fi

          # --- 5. ç”Ÿæˆ M3U ç»“æœ ---
          CURRENT_GROUP=""
          while IFS=$'\t' read -r TIME SPEED NAME URL AREA; do
              # è‡ªåŠ¨åˆ†ç»„é€»è¾‘
              GROUP_TITLE="å…¶ä»–"
              if [[ "$AREA" == "China" ]]; then
                  if [[ "$NAME" =~ "CCTV" || "$NAME" =~ "cctv" ]]; then
                      GROUP_TITLE="ä¸­å›½: å¤®è§†"
                  else
                      GROUP_TITLE="ä¸­å›½: å…¨å›½"
                      for KEY in "${!PROVINCE_MAP[@]}"; do
                          if [[ "$NAME" == *"$KEY"* || "$NAME" == *"${PROVINCE_MAP[$KEY]}"* ]]; then
                              GROUP_TITLE="ä¸­å›½: ${PROVINCE_MAP[$KEY]}"
                              break
                          fi
                      done
                  fi
              else
                  GROUP_TITLE="$AREA"
              fi

              if [[ "$GROUP_TITLE" != "$CURRENT_GROUP" ]]; then
                  echo -e "\n# === $GROUP_TITLE ===" >> playlist.m3u
                  CURRENT_GROUP="$GROUP_TITLE"
              fi

              # Logo åŒ¹é…é€»è¾‘ï¼šå»é™¤ç”»è´¨åç¼€å†åŒ¹é…å›¾æ ‡åº“ï¼Œä¿è¯å›¾æ ‡æˆåŠŸç‡
              LOGO_KEY=$(echo "$NAME" | sed -E 's/(é«˜æ¸…|HD|è¶…æ¸…|UHD|4K|FHD|æ ‡æ¸…|SD)//ig; s/ //g' | tr -dc '[:alnum:]')
              
              echo "#EXTINF:-1 tvg-logo=\"https://raw.githubusercontent.com/fanmingming/live/main/tvicon/${LOGO_KEY}.png\" group-title=\"$GROUP_TITLE\",$NAME" >> playlist.m3u
              echo "$URL" >> playlist.m3u
          done < <(sort -t$'\t' -k5,5 -k3,3 best_channels.txt)

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add playlist.m3u
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨: $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main
            git push origin main
          fi

      - name: Cleanup
        run: rm -f *.m3u valid_channels.txt best_channels.txt
